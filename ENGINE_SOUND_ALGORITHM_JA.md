# エンジン音生成アルゴリズム 詳細解説

このドキュメントは、Engine Simulator が採用しているリアルタイム・エンジン音合成アルゴリズムを日本語で詳細に説明するものです。

---

## 目次

1. [システム概要](#1-システム概要)
2. [全体アーキテクチャ](#2-全体アーキテクチャ)
3. [車両・エンジン物理モデル（app.js）](#3-車両エンジン物理モデルappjs)
4. [音声合成アルゴリズム（engine-processor.js）](#4-音声合成アルゴリズムengine-processorjs)
   - [ステップ 1：基本周波数とジッター](#ステップ-1基本周波数とジッター)
   - [ステップ 2：ハーモニクス合成（アンチエイリアシング付き）](#ステップ-2ハーモニクス合成アンチエイリアシング付き)
   - [ステップ 3：マルチバンドノイズ生成](#ステップ-3マルチバンドノイズ生成)
   - [ステップ 4：共鳴モデリング](#ステップ-4共鳴モデリング)
   - [ステップ 5：レブリミッター](#ステップ-5レブリミッター)
   - [ステップ 6：歪み処理（ディストーション）](#ステップ-6歪み処理ディストーション)
   - [ステップ 7：ポストフィルタと音量調整](#ステップ-7ポストフィルタと音量調整)
5. [エンジン固有モードの実装](#5-エンジン固有モードの実装)
   - [VTEC モード](#vtec-モード)
   - [FA24 ボクサーモード](#fa24-ボクサーモード)
   - [ターボモード](#ターボモード)
6. [オーディオエフェクトチェーン](#6-オーディオエフェクトチェーン)
7. [パラメータ一覧](#7-パラメータ一覧)
8. [処理フロー図](#8-処理フロー図)

---

## 1. システム概要

Engine Simulator は、録音済みの音声サンプルをまったく使わず、**純粋な数値計算（プロシージャル合成）** によってリアルタイムにエンジン音を生成します。

### 主な特徴

- **Web Audio API の `AudioWorklet`** を使用し、メインスレッドとは独立した専用スレッドで音声を処理することで低遅延を実現します。
- **ハーモニクス合成** により、実際のエンジンが持つ倍音構造を再現します。
- **マルチバンドノイズ** によって、吸気音・機械的摩擦音・燃焼爆発音を帯域ごとに合成します。
- **エンジン固有特性**（VTEC、ターボ、水平対向）を専用アルゴリズムで表現します。
- RPM・スロットル・車両負荷のリアルタイム変化に応じて、音色が連続的に変化します。

---

## 2. 全体アーキテクチャ

```
┌─────────────────────────────────────┐
│  index.html (プレゼンテーション層)  │
│  RPM表示、スロットルバー、各種操作  │
└─────────────────────────────────────┘
                  ↓ ユーザー操作
┌─────────────────────────────────────┐
│      app.js (アプリケーション層)    │
│  ・車両・エンジン物理シミュレーション│
│  ・RPM / スロットル / 負荷の計算    │
│  ・AudioWorklet へのパラメータ転送  │
└─────────────────────────────────────┘
                  ↓ AudioParam 経由
┌─────────────────────────────────────┐
│ engine-processor.js (オーディオ層)  │
│  ・ハーモニクス合成                 │
│  ・マルチバンドノイズ生成           │
│  ・共鳴・歪み処理                   │
│  ・エンジン固有特性                 │
└─────────────────────────────────────┘
                  ↓ PCM 出力
┌─────────────────────────────────────┐
│  EQ → コンプレッサー → リバーブ     │
│  (Web Audio API エフェクトチェーン) │
└─────────────────────────────────────┘
                  ↓
           スピーカー出力
```

### データフロー

1. ユーザーがスロットルを踏む（キーボード `Space` / `↑` / `W`、またはペダルボタン）
2. `app.js` がスロットル値・RPM・車両負荷を物理的に計算する
3. 計算結果が `AudioWorkletNode` の `AudioParam` を通じて `engine-processor.js` に送られる
4. `engine-processor.js` がサンプル単位でリアルタイムに音声波形を生成する
5. 生成された信号が EQ・コンプレッサー・リバーブを通過してスピーカーに出力される

---

## 3. 車両・エンジン物理モデル（app.js）

音声合成に入力されるパラメータ（RPM・スロットル・負荷）は、車両の物理モデルから計算されます。

### 3-1. トルクカーブ

実際のエンジンは回転数によって生み出せるトルクが異なります。このシミュレーターでは、以下の放物線状のトルクカーブを使用します。

```
baseTorque = 280 Nm（最大トルク）
norm       = (RPM - idleRpm) / (redlineRpm - idleRpm)   // 0～1 に正規化
mid        = 0.60   // RPM レンジの 60% 付近でピーク
width      = 0.40   // 曲線の幅

shape      = max(0, 1 - ((norm - mid) / width)²)
torque     = baseTorque × shape × (0.15 + 0.85 × throttle)
```

- スロットル全開時（throttle = 1.0）は最大トルクカーブに従います。
- スロットル全閉時（throttle = 0.0）でも **最大の 15%** のトルクが発生します（ポンピングロスや摩擦の模倣）。
- ピーク付近（RPM レンジ 60% ≈ 4,200〜4,800 rpm）で最大トルクになります。

### 3-2. 車両動力学

車両の加速・減速は以下の力の釣り合いで決まります。

| 項目 | 計算式 |
|---|---|
| 空気抵抗力 | `0.5 × 空気密度 × Cd × 前面積 × 速度²` |
| 転がり抵抗力 | `質量 × 重力加速度 × 転がり抵抗係数` |
| 勾配抵抗力 | `質量 × 重力加速度 × roadLoad × 0.25` |
| 駆動力 | `エンジントルク × 総ギア比 × 効率 / 車輪半径` |
| 合力 | `駆動力 − (空気抵抗 + 転がり抵抗 + 勾配抵抗)` |

**デフォルト車両パラメータ（スポーツカー設定）:**

| パラメータ | 値 |
|---|---|
| 質量 | 1,350 kg |
| 抗力係数（Cd） | 0.30 |
| 前面積 | 2.1 m² |
| 転がり抵抗係数 | 0.012 |
| ドライブライン効率 | 92% |
| ホイール半径 | 0.33 m（255/40R18 相当） |

**6速トランスミッションのギア比:**

| ギア | ギア比 |
|---|---|
| 1速 | 3.62 |
| 2速 | 2.19 |
| 3速 | 1.62 |
| 4速 | 1.27 |
| 5速 | 1.03 |
| 6速 | 0.82 |
| ファイナルドライブ | 3.42 |

### 3-3. RPM 物理シミュレーション

RPM は以下の手順で更新されます。

**① 目標 RPM の計算**

```
freeTargetRpm   = idleRpm + (redlineRpm - idleRpm) × throttle

// 内部抵抗（回転数 1.5 乗に比例）でターゲット RPM を引き下げる
rpmNorm         = currentRpm / redlineRpm
internalRes     = rpmNorm^1.5
resistanceFactor= 0.15 × internalRes
resistedTarget  = freeTargetRpm × (1 − resistanceFactor × (1 − throttle))
targetRpm       = max(idleRpm, resistedTarget)
```

**② 慣性による RPM 変化**

```
effectiveInertia = inertia + 負荷による補正
currentRpm       = currentRpm × effectiveInertia + targetRpm × (1 − effectiveInertia)
```

`inertia` の値（0.8〜0.99）が高いほどエンジンの「重さ」が増し、RPM の応答が遅くなります。

**③ 車速の計算**

```
speed = (currentRpm × 2π × wheelRadius) / (overallRatio × 60)
```

ギアチェンジ時は、現在の車速を維持するように RPM が即座に補正されます。

### 3-4. エンジン負荷の計算

負荷（load）は音声合成の音色に影響する重要なパラメータです。

```
抵抗負荷 = 必要トルク / 現在 RPM における最大トルク
慣性負荷 = (質量 × 加速度 × 車輪半径) / (最大トルク × 総ギア比 × 効率)

load = clamp(抵抗負荷 + 慣性負荷, 0, 1)
```

ニュートラル（ギア = 0）の場合は `load = 0.05`（ほぼ無負荷）として扱います。

---

## 4. 音声合成アルゴリズム（engine-processor.js）

`engine-processor.js` は Web Audio API の `AudioWorkletProcessor` として動作し、1 サンプルずつ以下の処理を実行します。処理は **サンプルレート（通常 44,100 Hz または 48,000 Hz）** で行われます。

### ステップ 1：基本周波数とジッター

#### 点火周波数の計算

エンジンが発生する音の基本となる「点火周波数」（1 秒間に何回爆発するか）を計算します。

```
f_fire = (RPM / 60) × (気筒数 / 2) × jitter × drift
```

- `RPM / 60`：1 秒あたりの回転数（Hz）
- `× (気筒数 / 2)`：4 ストロークエンジンは 2 回転に 1 回点火するため、気筒数の半分を掛けます（4 気筒なら 2×）。
- 例：4,000 rpm・4 気筒の場合 → `f_fire = (4000/60) × 2 ≈ 133 Hz`

#### ジッター（燃焼ばらつき）

実際のエンジンは各サイクルで燃焼タイミングにわずかなばらつきがあります。これを **ジッター** で再現します。

```
jitterAmount = JITTER_BASE + JITTER_RANGE × (1 − throttle)
jitter       = 1 + (乱数 − 0.5) × jitterAmount
```

- スロットルが小さいほど（アイドル時）ジッターが大きくなり、回転が「荒れた」音になります。
- スロットル全開時はジッターが最小になり、安定した高回転音になります。

#### ランダムウォーク（サイクル間ドリフト）

さらに微細なピッチ変動として、ゆっくり変化する **ランダムウォーク** を加えます。

```
randomWalk += (乱数 − 0.5) × RANDOM_WALK_RATE
randomWalk ×= RANDOM_WALK_DECAY   // ゆっくり減衰して中心に戻る
drift       = 1 + randomWalk
```

- `RANDOM_WALK_RATE = 0.00015`：非常にゆっくり変化します。
- `RANDOM_WALK_DECAY = 0.9995`：長期的には 0 に収束します。

これにより、シンセサイザーのような「機械的に正確な音」にならず、生きたエンジンのような微妙な揺らぎが得られます。

#### 位相の更新

```
phaseInc = (2π × f_fire) / sampleRate
phase    += phaseInc
if (phase > 2π) phase -= 2π
```

`phase` は 0〜2π を繰り返す鋸歯状波の位相で、すべての調波合成の基準となります。

---

### ステップ 2：ハーモニクス合成（アンチエイリアシング付き）

エンジン音の「芯」となる成分です。基本周波数の整数倍（倍音）を合成することで、エンジンらしい音色を作ります。

#### 倍音の振幅計算

```
signal = Σ(k=1 to HARMONIC_COUNT) amp_k × harmonicDamping × sin(k × phase + phaseOffset_k)
```

各倍音 k の振幅は以下で決まります。

```
amp_k = (1 / k^α) × harmonicColor_k
```

- `1 / k^α`：倍音次数が高いほど振幅が小さくなります（**べき乗則**）。αが大きいほど音が柔らかくなります。
- `harmonicColor_k`：各倍音に初期化時にランダムな色付けをすることで、完全な調波列（オルガン的な音）から外れます（0.85〜1.15 の範囲）。
- `phaseOffset_k`：各倍音に固定のランダム位相オフセットを加えることで、完全整数比の調波配列が崩れ、より有機的な音質になります。

#### アンチエイリアシング

デジタル音声ではナイキスト周波数（サンプルレートの半分）を超える倍音を生成するとエイリアシング（ノイズ）が発生します。これを防ぎます。

```
freq = k × f_fire
if (freq >= nyquist) break   // ナイキスト以上の倍音はスキップ
```

さらに 4,000 Hz 以上の倍音は徐々に減衰させます（高域ロールオフ）。

```
if (freq > 4000 Hz):
    amp_k ×= max(0, 1 − (freq − 4000) / 10000)
```

#### 気筒間ばらつき（Cylinder-to-Cylinder Variation）

各気筒の点火は完全には等間隔でなく、振幅もわずかに異なります。これを再現することで「機械的なリズム感」が生まれます。

```
for (cyl = 0 to ncyl - 1):
    cylPhase  = phase + cyl × (2π / cylPerRev) + cylinderPhaseOffset[cyl]
    cylAmp    = cylinderAmplitude[cyl]  // 0.92〜1.08 の範囲でランダム
    cylPulse  = max(0, sin(cylPhase))^5  // 尖った正のパルス
    contribution += cylAmp × cylPulse × 0.15
```

- `sin^5` の冪乗により、正弦波から鋭いパルス状の波形が得られます。
- この成分が各気筒の爆発感（パルス感）を表現します。

---

### ステップ 3：マルチバンドノイズ生成

実際のエンジンは調波成分だけでなく、広帯域の「騒音」も発生します。このシミュレーターでは、帯域ごとに異なる特性のノイズを加算します。

まず共通のホワイトノイズ（-1〜+1 の一様乱数）を生成します。
```
white = Math.random() × 2.0 − 1.0
```

#### ① 吸気ノイズ（Intake Rumble）

スロットルが開くと吸気口から発生する低〜中域の轟音です。

```
// ローパスフィルタ（1次 IIR）
lpfAlpha     = 0.05 + 0.18 × throttle   // スロットルが大きいほど高域まで通す
lpfState    += lpfAlpha × (white − lpfState)

intakeNoise  = (0.35 + 1.35 × throttle + 0.4 × loadStress) × lpfState
```

- スロットルが大きいほど吸気ノイズが増加し、高域の成分も増えます。
- 負荷（loadStress）が高いほど吸気ノイズが増します。

#### ② 機械的ノイズ（Mechanical Hiss）

バルブ、ベルト、ギアなどから発生する高周波の機械音です。

```
// ハイパスフィルタ（1次 IIR）
hpfState   += 0.055 × (white − hpfState)
hpf         = white − hpfState   // ローパス成分を引いて高域だけ取り出す

rpmNorm     = min(1, RPM / 8000)
mechNoise   = (0.18 + 0.75 × rpmNorm + 0.5 × loadStress) × hpf
```

- RPM が高いほど機械的ノイズが増します（高回転ではメカニズムが激しく動くため）。

#### ③ 燃焼クラックル（Combustion Crackle）

燃焼爆発に同期した不規則なパルス音です。

```
cycleEnergy = 0.5 + 0.5 × sin(phase)          // 点火サイクルに同期
burst       = cycleEnergy^(3.2 − 0.8 × loadStress)  // 負荷が高いと爆発が荒くなる

combPulse   = 0.9 × combPulse + 0.1 × burst   // ローパスで平滑化
combustionNoise = combPulse × white × (0.2 + 0.9 × throttle + 0.6 × loadStress)
```

- `sin(phase)` により点火タイミングに同期した周期的なバースト（爆発感）を作ります。
- 負荷が高いほど燃焼が不規則になり、音が荒くなります。

#### ④ バルブトレインクリック（Valvetrain Noise）

吸気・排気バルブの開閉音（カチカチ音）を再現します。

```
valveFreq        = f_fire × 2    // 1 回転に 2 回（吸気と排気）バルブが動く
valveClickEnv    = max(0, sin(valveClickPhase))^12   // 非常に鋭いパルス
valveClick       = valveClickEnv × hpf × (0.08 + 0.12 × rpmNorm)
```

- 12 乗の冪乗により、極めて短い鋭いクリック音を生成します。
- RPM が高いほどクリックが目立ちます。

#### ⑤ 減速バックファイヤー（Deceleration Backfire）

スロットルを急に離したとき（減速時）、排気管でパンパンと音が鳴る現象を再現します。

```
throttleDrop   = max(0, lastThrottle − throttle)
decelWindow    = max(0, 1 − |RPM − 4500| / 3500)  // 4500 rpm 付近で最大
backfireTrigger = throttleDrop > 0.3 ? random() : 0
backfirePulse   = max(backfirePulse × 0.94, backfireTrigger × decelWindow)
backfireNoise   = backfirePulse × white² × (0.35 + 0.65 × lpfState)
```

- スロットルの急激な低下（0.3 以上の落ち込み）でバックファイヤーがランダムにトリガーされます。
- `0.94` の減衰係数により、パンッという短い音が残像のように続きます。
- `white²` により、正の値に偏ったパルス音になります（高域成分が豊か）。

#### 負荷ストレス係数

エンジン負荷が高いほど、ノイズが全体的に増加します。

```
loadStress = load × (0.3 + 0.7 × throttle)
```

---

### ステップ 4：共鳴モデリング

#### ④a. ボディ共鳴（Body Resonance）

車体やエンジンルームは特定の周波数で共鳴します。シンプルなバンドパスフィルタで近似します。

```
bpfState += 0.02 × (signal − bpfState)
signal   += 0.6 × bpfState
```

低域の共鳴成分が加わり、音に「厚み」が生まれます。

#### ④b. 排気管共鳴（Exhaust Resonance）

排気管は管の長さに応じた共振周波数を持ちます。RPM が上がると排気圧が変化し、共鳴周波数がわずかにシフトします。3 つの共鳴ピークで排気系を近似します。

| 共鳴ピーク | 基準周波数 | RPM スケール | ゲイン |
|---|---|---|---|
| 低域共鳴（Res1） | 180 Hz | +0.02 × RPM | 0.28 |
| 中域共鳴（Res2） | 650 Hz | +0.04 × RPM | 0.22 |
| 高域共鳴（Res3） | 1,800 Hz | +0.08 × RPM | 0.15 |

```
exhaustRes1Freq = 180 + RPM × 0.02
res1Alpha       = min(0.45, 2π × exhaustRes1Freq / sampleRate)
exhaustRes1State += res1Alpha × (signal − exhaustRes1State)

// 同様に Res2, Res3 も計算

exhaustResonance = 0.28 × res1State + 0.22 × res2State + 0.15 × res3State
signal          += exhaustResonance × (0.5 + 0.5 × throttle)
```

これにより、実際の排気管のような「マフラーサウンド」の特性が加わります。スロットルが大きいほど共鳴が強くなります。

---

### ステップ 5：レブリミッター

レッドライン付近での燃料カット（フューエルカット）を再現します。

```
if (RPM > redlineRpm × 0.98):
    revLimiterCycle += 0.15
    if (revLimiterCycle > 1) revLimiterCycle = 0
    // サイクルの 30% で燃料カット（音が急激に小さくなる）
    revLimiterCut = (revLimiterCycle < 0.3) ? 0.05 : 1.0
else:
    revLimiterCut = 1.0

signal ×= revLimiterCut
```

- レブリミッターが作動すると、高速でオン/オフが繰り返され、「バチバチ」という特徴的な音になります。
- カット中（0.05 倍）も完全にゼロにはしないので、若干の残響が残ります。

---

### ステップ 6：歪み処理（ディストーション）

実際のエンジン音は、特に高負荷・高回転時に調波歪みが生じます。双曲線正接（tanh）によるソフトクリッピングで、アナログ的な歪みを再現します。

```
drive  = 0.9 + 2.2 × throttle + 0.35 × vtecBlend + 0.28 × fa24Mode + 0.4 × loadStress
signal = tanh(drive × signal)
```

- `tanh` は入力が大きくなるにつれて ±1 に近づく S 字カーブで、穏やかに波形をクリップします。
- スロットルが大きいほど・VTEC が作動しているほど・負荷が高いほど歪みが強くなります。
- ハードクリッピング（単純な max/min カット）と違い、倍音が自然な形で増加します。

**tanh の動作イメージ:**
```
入力が小さい → 出力 ≈ 入力（ほぼ線形）
入力が大きい → 出力が ±1 に近づく（クリッピング）
```

---

### ステップ 7：ポストフィルタと音量調整

最終段に軽いローパスフィルタを掛けて、高 RPM 時の「耳障りなザラつき」を低減します。

```
postLpfAlpha  = 0.12 + 0.10 × throttle
postLpfState += postLpfAlpha × (signal − postLpfState)

signal = 0.82 × postLpfState + 0.18 × signal  // 82% フィルタ済み + 18% 生信号
```

- スロットルが大きいほどフィルタが開き、より多くの高域成分が通過します（高回転の鋭い音）。
- スロットルが小さいほどフィルタが閉じ、アイドル時の丸みのある音になります。

最後にマスターボリュームを掛けて出力します。

```
signal ×= 0.34   // MASTER_VOLUME
```

---

## 5. エンジン固有モードの実装

### VTEC モード

ホンダの VTEC（Variable Valve Timing and Lift Electronic Control）を再現します。低回転では穏やかな音色で、高回転ではカムが切り替わり激しく音色が変化します。

#### カム切替ブレンド計算

```
クロスオーバー中心 = 5,600 rpm
クロスオーバー幅   = 900 rpm

x         = (RPM − 5,150) / 900   // 0〜1 に正規化
vtecBlend = vtecMode × smoothstep(x)   // スムーズステップで滑らかに遷移
```

`smoothstep(x) = x² × (3 − 2x)` で、急激でなく自然な遷移を実現します。

#### 倍音スペクトルの変化

| パラメータ | 低カム（〜5,600 rpm） | 高カム（5,600 rpm〜） |
|---|---|---|
| α（倍音減衰） | 1.35 | 1.00（高域倍音が増加） |
| 倍音ダンピング | 〜0.95 | 〜0.70（透明感が増す） |
| 7次以上の倍音 | 通常 | ×1.55 倍（高調波増強） |

```
// 高カム時は 7次以上の倍音を強調
if (k >= 7):
    amp_k ×= 1.0 + 0.55 × vtecBlend
```

#### VTEC 特有の吸気エッジ

VTEC 作動時には吸気口から聞こえる独特の「ッシュー」という音が加わります。

```
vtecIntakeEdge = vtecBlend × (0.08 + 0.22 × throttle) × (intakeNoise + 0.6 × hpf)
```

### FA24 ボクサーモード

スバル FA24 型水平対向 4 気筒エンジンの特有の「ドロドロ」サウンドを再現します。

#### 水平対向サウンドの特徴と実装

水平対向エンジンは、向かい合ったシリンダーが完全に等間隔で点火しないため、独特の不均一なパルス感（「ドロドロ」「ボコボコ」）が生まれます。

**1. 非等間隔パルスペア**

```
pulseA    = max(0, sin(phase + 0.10))^7   // 鋭い正のパルス
pulseB    = max(0, sin(phase + 1.22))^7   // 0.10 と 1.22 の差 ≈ 62.6° オフセット
pairedPulse = pulseA + 0.78 × pulseB     // 非対称なペアパルス
```

1.22 ラジアン（約 70°）の位相差がボクサーエンジンの点火ずれを模倣します。

**2. ローピング（揺れるようなリズム）**

```
loping = 0.55 + 0.45 × sin(phase × 0.5 + 0.9)
boxerPulse = 0.84 × boxerPulse + 0.16 × pairedPulse × loping
```

`0.5 × phase`（基本周波数の半分）のサイン波でゆっくり揺れる包絡線を生成します。これがボクサーの「ローピング」感（ゆったり揺れるリズム）を作ります。

**3. 低中域ランブル**

```
boxerFund      = sin(phase × 0.5 + 0.2)   // 基音の半分（サブ成分）
boxerOdd       = sin(phase × 1.5 + 1.0)   // 3/2 次（奇数倍音強調）
boxerLow       = 0.62 × boxerFund + 0.34 × boxerOdd
boxerRumble    = (0.58 + 0.42 × boxerPulse) × boxerRumble_filtered
```

**4. 通常のハーモニクスとのブレンド**

```
signal = signal × (1 − 0.22 × boxerMode) + boxerRumble × (0.72 × boxerMode)
```

通常のハーモニクスの 22% を削り、ボクサーランブルの 72% を加えることで、水平対向らしいモコモコした低域感を作ります。

**5. 低域強調**

```
// 1〜3 次の倍音を強調（低域重視）
if (k <= 3): amp_k ×= 1 + boxerLump × (0.95 − 0.2 × k)

// 6 次以上を抑制（高域を削る）
if (k >= 6): amp_k ×= max(0.45, 1 − 0.085 × (k − 5) × fa24Mode)
```

**6. リフトオフバーブル**

スロットルを急に戻したときの「バラバラ」という音です。

```
rpmWindow    = max(0, 1 − |RPM − 3200| / 2600)   // 3200 rpm 付近
liftOff      = max(0, 0.35 − throttle) / 0.35    // スロットル 0.35 以下で発生
boxerBurble  = fa24Mode × rpmWindow × liftOff × (0.16 + 0.22 × white²)
```

### ターボモード

ターボチャージャーのホイール回転音（ホイッスル）とブースト時のホワイトノイズ（ウーシュ）を付加します。

#### ターボスプール音

```
turboSpool     = turboMode × max(0, throttle − 0.2) × min(1, RPM / 7000)
whistleFreq    = 10000 + 3000 × turboSpool   // 10〜13 kHz の高音
turboPhase    += 2π × whistleFreq / sampleRate
whistle        = sin(turboPhase) × (0.12 × turboSpool)
```

- スロットルが 0.2 以上で、かつ 7,000 rpm 以上でフルブーストになります。
- 周波数 10〜13 kHz の高い「ヒューン」という音がターボの特徴です。

#### ターボウーシュ（ブースト音）

```
turboWhoosh = turboSpool × (0.2 + 0.8 × throttle) × hpf
```

ハイパスフィルタ済みのノイズを使うことで、高域成分が多い「シャーッ」という排気音を生成します。

---

## 6. オーディオエフェクトチェーン

`engine-processor.js` で生成された音声は、Web Audio API のエフェクトノードチェーンを通過して最終出力されます。

```
engineNode
    → EQ (低域シェルフ → ピーキング → 高域シェルフ)
    → ダイナミクスコンプレッサー
    → ドライ/ウェット分岐
        ドライパス: → dryGain → masterGain → スピーカー
        ウェットパス: → convolver (リバーブ) → wetGain → masterGain → スピーカー
```

### イコライザー（EQ）

3 バンド EQ で「聴取視点」を切り替えます。

| 視点 | 低域シェルフ | ミッドピーキング | 高域シェルフ |
|---|---|---|---|
| 車外（Exterior） | 120 Hz / +4 dB | 800 Hz / −2 dB | 3,000 Hz / −6 dB |
| 車内（Interior） | 100 Hz / +6 dB | 500 Hz / +3 dB | 2,500 Hz / −10 dB |
| エンジンルーム（Engine Bay） | 150 Hz / −2 dB | 1,200 Hz / +4 dB | 4,000 Hz / +8 dB |

- **車外**：中域を少し抑えてマフラーから聞こえる音を模倣
- **車内**：低域を強調し、密室内の音場を模倣
- **エンジンルーム**：高域を大きく持ち上げ、メカニカルな音を模倣

### ダイナミクスコンプレッサー

音量の大きな変動を自動的に圧縮し、聴きやすいレベルに整えます。

```
threshold = −24 × amount (dB)
knee      = 30 × amount
ratio     = 2 + 10 × amount
attack    = 3 ms
release   = 250 ms
```

`amount` を増やすと圧縮が強くなり、より「太く」「聴きやすい」音になります。

### リバーブ（残響）

インパルス応答（IR）合成による残響効果です。

```javascript
// 2 秒間の指数減衰型インパルス応答を生成
for (let i = 0; i < length; i++) {
    const t = i / sampleRate;
    const envelope = Math.exp(−t × decay);   // 指数減衰
    left[i]  = (乱数 × 2 − 1) × envelope;
    right[i] = (乱数 × 2 − 1) × envelope;
}
```

ランダムな白色雑音を指数関数で減衰させたインパルス応答により、自然な残響音が得られます。ドライ/ウェットのミックス比率でリバーブの強さを調整します。

---

## 7. パラメータ一覧

### AudioWorklet に渡されるパラメータ

| パラメータ名 | 範囲 | デフォルト | 説明 |
|---|---|---|---|
| `rpm` | 0〜12,000 | 1,000 | エンジン回転数 |
| `throttle` | 0〜1 | 0.15 | スロットル開度 |
| `ncyl` | 1〜12 | 4 | 気筒数 |
| `noiseGain` | 0〜1 | 0.2 | ノイズ成分の全体ゲイン |
| `turboMode` | 0/1 | 0 | ターボモード有効フラグ |
| `boxerMode` | 0/1 | 0 | ボクサーモード有効フラグ |
| `vtecMode` | 0/1 | 0 | VTEC モード有効フラグ |
| `fa24Mode` | 0/1 | 0 | FA24 ボクサーモード有効フラグ |
| `redlineRpm` | 3,000〜12,000 | 7,000 | レッドライン RPM |
| `load` | 0〜1 | 0 | エンジン負荷 |

### 主要な合成定数（SynthConstants）

| 定数名 | デフォルト値 | 説明 |
|---|---|---|
| `HARMONIC_COUNT` | 24 | 合成する倍音の最大次数 |
| `HARMONIC_ROLLOFF_FREQ` | 4,000 Hz | 高域ロールオフ開始周波数 |
| `JITTER_BASE` | 0.001 | ジッターの最小量 |
| `JITTER_RANGE` | 0.003 | スロットル依存のジッター幅 |
| `VTEC_CROSSOVER_CENTER` | 5,600 rpm | VTEC カム切替中心回転数 |
| `VTEC_CROSSOVER_WIDTH` | 900 rpm | VTEC 遷移帯域幅 |
| `BACKFIRE_DECAY` | 0.94 | バックファイヤーパルスの減衰率 |
| `MASTER_VOLUME` | 0.34 | 最終出力音量 |

---

## 8. 処理フロー図

以下は、1 サンプルが処理される際の信号の流れを示しています。

```
RPM, throttle, ncyl, load (AudioParam)
         │
         ▼
┌──────────────────────────────────────┐
│ ステップ 1: 基本周波数計算            │
│   f_fire = RPM/60 × ncyl/2           │
│   jitter, randomWalk で揺らぎを付与  │
│   phase += 2π × f_fire / sampleRate  │
└──────────────────────────────────────┘
         │ phase
         ▼
┌──────────────────────────────────────┐
│ ステップ 2: ハーモニクス合成          │
│   Σ amp_k × sin(k×phase + offset_k) │
│   + 気筒間ばらつき                   │
│   + FA24/VTEC 特有の調整             │
└──────────────────────────────────────┘
         │ 調波信号
         ▼
┌──────────────────────────────────────┐
│ ステップ 3: マルチバンドノイズ生成    │
│   + 吸気ノイズ（LPF）                │
│   + 機械的ノイズ（HPF）              │
│   + 燃焼クラックル                   │
│   + バルブトレインクリック            │
│   + 減速バックファイヤー              │
│   + ターボホイッスル/ウーシュ         │
│   + FA24/VTEC 特有ノイズ             │
└──────────────────────────────────────┘
         │ 信号 + ノイズ
         ▼
┌──────────────────────────────────────┐
│ ステップ 4: 共鳴モデリング            │
│   + ボディ共鳴（BPF）                │
│   + 排気管共鳴（3バンド）            │
└──────────────────────────────────────┘
         │
         ▼
┌──────────────────────────────────────┐
│ ステップ 5: レブリミッター            │
│   RPM > redline×0.98 → フューエルカット│
└──────────────────────────────────────┘
         │
         ▼
┌──────────────────────────────────────┐
│ ステップ 6: tanh 歪み処理             │
│   signal = tanh(drive × signal)      │
└──────────────────────────────────────┘
         │
         ▼
┌──────────────────────────────────────┐
│ ステップ 7: ポストフィルタ + 音量     │
│   ローパスフィルタ（可変カットオフ）  │
│   × MASTER_VOLUME (0.34)             │
└──────────────────────────────────────┘
         │ PCM 出力
         ▼
┌──────────────────────────────────────┐
│ エフェクトチェーン（app.js 管理）     │
│   EQ（3バンド） → コンプレッサー     │
│   → ドライ/ウェット → リバーブ       │
└──────────────────────────────────────┘
         │
         ▼
      スピーカー
```

---

## 関連ドキュメント

- **[readme.md](readme.md)** - プロジェクト概要（日英バイリンガル）
- **[REQUIREMENTS.md](REQUIREMENTS.md)** - 完全な要件定義書
- **[MOBILE_GUIDE_JA.md](MOBILE_GUIDE_JA.md)** - スマホ版開発ガイド（日本語）
- **[AI_INSTRUCTIONS.md](AI_INSTRUCTIONS.md)** - AI 向け実装ガイド（英語）

---

**作成日：** 2026年2月20日  
**バージョン：** 1.0  
**対象ファイル：** `engine-processor.js`、`app.js`
